!function(e){e.fn.tagedit=function(t){function i(){var i='<ul class="tagedit-list '+t.additionalListClass+'">';d.each(function(){var a=e(this).attr("name").match(o);if(a&&4==a.length&&(0==t.deleteEmptyItems||e(this).val().length>0)&&a[1].length>0){var n="undefined"!=typeof a[2]?a[2]:"";i+='<li class="tagedit-listelement tagedit-listelement-old">',i+='<span dir="'+t.direction+'">'+e(this).val()+"</span>",i+='<input type="hidden" name="'+u+"["+n+']" value="'+e(this).val()+'" />',i+='<a class="tagedit-close" title="'+t.texts.removeLinkTitle+'">x</a>',i+="</li>"}}),d.last().after(i);var n=d.last().next();d.remove(),d=n,t.deletedPostfix.length>0&&d.find('input[name$="'+t.deletedPostfix+']"]').each(function(){s(e(this).parent())}),i='<li class="tagedit-listelement tagedit-listelement-new">',i+='<input type="text" name="'+u+'[]" value="" id="tagedit-input" disabled="disabled" class="tagedit-input-disabled" dir="'+t.direction+'"/>',i+="</li>",i+="</ul>",d.append(i).find("#tagedit-input").each(function(){e(this).autoGrowInput({comfortZone:15,minWidth:15,maxWidth:2e4}),e(this).bind("transformToTag",function(a,n){var s="undefined"!=typeof n&&(n.length>0||n>0),r=1==s?!1:!0,d=l(e(this).val(),r);if((d[0]===!0||d[0]===!1&&"string"==typeof d[1])&&(0==s&&"string"==typeof d[1]&&(s=!0,n=d[1]),1==t.allowAdd||s)){i='<li class="tagedit-listelement tagedit-listelement-old">',i+='<span dir="'+t.direction+'">'+e(this).val()+"</span>";var o=s?u+"["+n+t.addedPostfix+"]":u+"[]";i+='<input type="hidden" name="'+o+'" value="'+e(this).val()+'" />',i+='<a class="tagedit-close" title="'+t.texts.removeLinkTitle+'">x</a>',i+="</li>",e(this).parent().before(i)}e(this).val(""),t.autocompleteOptions.source&&e(this).autocomplete("close")}).keydown(function(i){var a=i.keyCode>0?i.keyCode:i.which;switch(a){case 8:if(0==e(this).val().length){var n=d.find("li.tagedit-listelement-old").last();return n.fadeOut(t.animSpeed,function(){n.remove()}),i.preventDefault(),!1}break;case 9:if(e(this).val().length>0&&0==e("ul.ui-autocomplete #ui-active-menuitem").length)return e(this).trigger("transformToTag"),i.preventDefault(),!1}return!0}).keypress(function(i){var a=i.keyCode>0?i.keyCode:i.which;return e.inArray(a,t.breakKeyCodes)>-1?(e(this).val().length>0&&0==e("ul.ui-autocomplete #ui-active-menuitem").length&&e(this).trigger("transformToTag"),i.preventDefault(),!1):!0}).bind("paste",function(t){var i=e(this);"paste"==t.type&&setTimeout(function(){i.trigger("transformToTag")},1)}).blur(function(){if(0==e(this).val().length)e(this).attr("disabled","disabled").addClass("tagedit-input-disabled");else{var t=e(this);e(this).data("blurtimer",window.setTimeout(function(){t.val("")},500))}}).focus(function(){window.clearTimeout(e(this).data("blurtimer"))}),0!=t.autocompleteOptions.source&&e(this).autocomplete(t.autocompleteOptions)}).end().click(function(i){switch(i.target.tagName){case"A":e(i.target).parent().fadeOut(t.animSpeed,function(){e(i.target).parent().remove()});break;case"INPUT":case"SPAN":case"LI":if(0==e(i.target).hasClass("tagedit-listelement-deleted")&&0==e(i.target).parent("li").hasClass("tagedit-listelement-deleted"))return a(i);default:e(this).find("#tagedit-input").removeAttr("disabled").removeClass("tagedit-input-disabled").focus()}return!1})}function a(i){if(0!=t.allowEdit){var a="SPAN"==i.target.tagName?e(i.target).parent():e(i.target),r=null;a.bind("finishEdit",function(t,i){window.clearTimeout(r);var a=e(this).find(":text"),n=l(a.val(),!0);return a.val().length>0&&("undefined"==typeof i||i===!1)&&1==n[0]&&(e(this).find(":hidden").val(a.val()),e(this).find("span").html(a.val())),a.remove(),e(this).find("a.tagedit-save, a.tagedit-break, a.tagedit-delete").remove(),e(this).removeClass("tagedit-listelement-edit").unbind("finishEdit"),!1});var d=a.find(":hidden");html='<input type="text" name="tmpinput" autocomplete="off" value="'+d.val()+'" class="tagedit-edit-input" dir="'+t.direction+'"/>',html+='<a class="tagedit-save" title="'+t.texts.saveEditLinkTitle+'">o</a>',html+='<a class="tagedit-break" title="'+t.texts.breakEditLinkTitle+'">x</a>',1==t.allowDelete&&a.find(":hidden").length>0&&"undefined"!=typeof a.find(":hidden").attr("name").match(o)[3]&&(html+='<a class="tagedit-delete" title="'+t.texts.deleteLinkTitle+'">d</a>'),d.after(html),a.addClass("tagedit-listelement-edit").find("a.tagedit-save").click(function(){return e(this).parent().trigger("finishEdit"),!1}).end().find("a.tagedit-break").click(function(){return e(this).parent().trigger("finishEdit",[!0]),!1}).end().find("a.tagedit-delete").click(function(){if(window.clearTimeout(r),confirm(t.texts.deleteConfirmation)){var i=n(e(this).parent());!i&&confirm(t.texts.forceDeleteConfirmation)&&s(e(this).parent()),i&&s(e(this).parent()),e(this).parent().find(":text").trigger("finishEdit",[!0])}else e(this).parent().find(":text").trigger("finishEdit",[!0]);return!1}).end().find(":text").focus().autoGrowInput({comfortZone:10,minWidth:15,maxWidth:2e4}).keypress(function(t){switch(t.keyCode){case 13:return t.preventDefault(),e(this).parent().trigger("finishEdit"),!1;case 27:return t.preventDefault(),e(this).parent().trigger("finishEdit",[!0]),!1}return!0}).blur(function(){var t=e(this);r=window.setTimeout(function(){t.parent().trigger("finishEdit",[!0])},500)})}}function n(i){if(null===t.checkToDeleteURL)return!1;var a=i.find("input:hidden").attr("name"),n=new RegExp("\\d"),s=a.match(n),l=!1;return e.ajax({async:!1,url:t.checkToDeleteURL,dataType:"json",type:"POST",data:{tagId:s},complete:function(t){var i=e.parseJSON(t.responseText);i.success===!0&&(l=i.allowDelete)}}),l}function s(i){i.trigger("finishEdit",[!0]).addClass("tagedit-listelement-deleted").attr("title",t.deletedElementTitle),i.find(":hidden").each(function(){var i=new RegExp("("+t.addedPostfix+"|"+t.deletedPostfix+")?]"),a=e(this).attr("name").replace(i,t.deletedPostfix+"]");e(this).attr("name",a)})}function l(i,a){a="undefined"==typeof a?!1:a;var n=null,s=1==t.checkNewEntriesCaseSensitive?i:i.toLowerCase(),l=!0;if(d.find("li.tagedit-listelement-old input:hidden").each(function(){var i=1==t.checkNewEntriesCaseSensitive?e(this).val():e(this).val().toLowerCase();i==s&&(l=!1)}),1==l&&1==a&&0!=t.autocompleteOptions.source){var r=[];if(e.isArray(t.autocompleteOptions.source))r=t.autocompleteOptions.source;else if(e.isFunction(t.autocompleteOptions.source))t.autocompleteOptions.source({term:i},function(e){r=e});else if("string"==typeof t.autocompleteOptions.source){var o=t.autocompleteOptions.source;o+=o.match(/\?/)?"&":"?",o+="term="+i,e.ajax({async:!1,url:o,dataType:"json",complete:function(t){r=e.parseJSON(t.responseText)}})}for(var u=0;u<r.length;u++){var c=r[u].label?r[u].label:r[u],f=1==t.checkNewEntriesCaseSensitive?c:c.toLowerCase();if(f==s){l=!1,n="string"==typeof r[u]?u:r[u].id;break}}}return new Array(l,n)}if(t=e.extend(!0,{autocompleteURL:null,checkToDeleteURL:null,deletedPostfix:"-d",addedPostfix:"-a",additionalListClass:"",allowEdit:!0,allowDelete:!0,allowAdd:!0,direction:"ltr",animSpeed:500,autocompleteOptions:{select:function(t,i){return e(this).val(i.item.value).trigger("transformToTag",[i.item.id]),!1}},breakKeyCodes:[13,44],checkNewEntriesCaseSensitive:!1,texts:{removeLinkTitle:"Remove from list.",saveEditLinkTitle:"Save changes.",deleteLinkTitle:"Delete this tag from database.",deleteConfirmation:"Are you sure to delete this entry?",deletedElementTitle:"This Element will be deleted.",breakEditLinkTitle:"Cancel",forceDeleteConfirmation:"There are more records using this tag, are you sure do you want to remove it?"}},t||{}),0!=this.length){t.autocompleteURL&&(t.autocompleteOptions.source=t.autocompleteURL);var r=this.attr("dir");r&&r.length>0&&(t.direction=this.attr("dir"));var d=this,o=new RegExp("^(.*)\\[([0-9]*?("+t.deletedPostfix+"|"+t.addedPostfix+")?)?]$","i"),u=d.eq(0).attr("name").match(o);if(!u||4!=u.length)return void alert("elementname dows not match the expected format (regexp: "+o+")");u=u[1],i()}}}(jQuery);